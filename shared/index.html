<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name='viewport' content='width=device-width, initial-scale=1.0' />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/signalr.js/2.4.3/jquery.signalR.min.js"
    type="text/javascript"></script>
  <title>QR Check-In Lib</title>
</head>

<body>
  <div>BARCODE SCANNER DEBUG</div>
  <div id="barcode-conn-status">CONNECTED</div>
  <div id="log"></div>

  <div id='app'><!--outlet--></div>
  <script type='module' src='/src/entry-client.jsx'></script>
  <script>
    var devMgrConnStr = "http://localhost:60559/signalr";
    var scannerIdx = 0;
    var scannerDevInterface = undefined;

    var conn = $.hubConnection(devMgrConnStr);

    conn.reconnecting(function () {
      console.log("Attempting to reconnect to signalR");
    })

    conn.reconnected(function () {
      console.log("signalR reconnected");
    })

    conn.disconnected(function () {
      console.error("signalR disconnected");
      $("#barcode-conn-status").css({ 'color': 'red' })

      setTimeout(function () {
        conn.start().done(function () {
          console.log("signalR connected");
          $("#barcode-conn-status").css({ 'color': 'green' })
        }).fail(function (err) {
          console.error(JSON.stringify(err));
          $("#barcode-conn-status").css({ 'color': 'red' })
        });
      }, 5000)
    });

    var proxy = conn.createHubProxy("deviceManagerHub");

    // If we want to receive events prior to making method calls, then we must register an event before connection.start() is called.
    // Register a dummy event called: '_a'
    proxy.on('_a', function () { });

    conn.start().done(function () {
      console.log("signalR is connected");
      $("#barcode-conn-status").css({ 'color': 'green' })

      // Get all of the device components
      proxy.invoke('GetAllComponents').done(function (comps) {

        console.log("COMPS", comps);

        // Find all active barcode scanner components
        var accItems = comps.filter(function (c) {
          return c.ComponentTypeName === "Barcode_Scanner" && c.IsActive;
        });
        accItems = accItems || [];	// Do an 'OR' operation to assign an empty array if no components were found.

        if (accItems.length > 0) {
          // Use the first barcode scanner component.
          var scannerItem = accItems[0];
          scannerIdx = scannerItem.CompIdx;
          scannerDevInterface = scannerItem.DeviceManagerInterface;

          // This is the recommended approach to obtaining the idx and interface variables. Setting these manually will
          // require a code change; but this approach is dynamic.
          console.log("CALLING DEFINE EVENTS");

          proxy.invoke("BarcodeScanner_Connect", scannerIdx, scannerDevInterface).done(function () {
            console.log("SUCCESS CONNECTION TO BARCODE SCANNER");
            defineEvents();
          }).fail(function (err) {
            console.error(err);
          })
        }
        else {
          console.error("A barcode scanner component wasn't found in the configuration.");
        }

      }).fail(function (err) {
        console.error(err);
      });
    }).fail(function (err) {
      console.error(err);
      $("#barcode-conn-status").css({ 'color': 'red' })
    });

    function defineEvents() {

      // Detach the event handlers. This is done here because if defineEvents() is called again, then these events won't be registered multiple times and cause duplicate event firings.
      proxy.off('onBarcodeScannerConnected_Event');
      proxy.off('onBarcodeScannerConnectedError_Event');
      proxy.off('onBarcodeScanned_Event');
      proxy.off('onBarcodeScannerTriggerTimeout_Event');

      // Attach the event handlers
      proxy.on('onBarcodeScannerConnected_Event', function (evt) {
        $("#barcode-conn-status").css({ 'color': 'green' })
        console.log('Connected');
        console.log(JSON.stringify(evt));
      });

      proxy.on('onBarcodeScannerConnectedError_Event', function (evt) {
        $("#barcode-conn-status").css({ 'color': 'red' })
        console.log('Connection Error');
        console.log(evt.Payload);
      });

      proxy.on('onBarcodeScanned_Event', function (evt) {
        console.log('Barcode Scanned');
        console.log(evt.Payload);
        $("#log").append(evt.Payload)
        window.location.href = evt.Payload;
      });

      proxy.on('onBarcodeScannerTriggerTimeout_Event', function (evt) {
        console.log('Scan Timeout');
        console.log(evt.Payload);
      });
    }
  </script>
</body>

</html>
